<html lang="es"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEO-LOGIC: Spaced &amp; Small (v84)</title>
<style>
        /* --- ESTILOS GENERALES --- */
        :root { 
            --bg-color: #F0F4F8; 
            --accent-color: #1a3c3c; 
            --text-color: #333;
            --shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        body { 
            background-color: var(--bg-color); 
            /* --- INICIO CONFIGURACI√ìN DE FONDO --- */
            background-image: url('img/fondo.jpg'); /* Aseg√∫rate de que la imagen se llame as√≠ y est√© en la carpeta img */
            background-repeat: repeat;              /* 'repeat' para mosaico, 'no-repeat' para una sola vez */
            background-size: 256px;                 /* Ajusta este n√∫mero para que el patr√≥n sea m√°s grande o peque√±o */
            background-position: center;
            background-attachment: fixed;           /* 'fixed' para que el fondo no se mueva al hacer scroll */
            /* --- FIN CONFIGURACI√ìN DE FONDO --- */
            color: var(--text-color); 
            font-family: 'Segoe UI', 'Roboto', sans-serif; 
            margin: 0; height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; 
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        
        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            
            /* --- CAMBIO IMPORTANTE AQU√ç --- */
            /* Antes pon√≠a: var(--bg-color). C√°mbialo a esto: */
            background: rgba(240, 244, 248, 0.5); /* El 0.5 hace que sea semitransparente para ver el fondo */
            backdrop-filter: blur(3px);           /* Opcional: difumina un poco tu foto para que el texto se lea mejor */
            /* ----------------------------- */

            transition: opacity 0.3s; opacity: 0; pointer-events: none; z-index: 0; 
        }
        .screen.active { opacity: 1; pointer-events: all; z-index: 10; }

        /* --- MEN√ö PRINCIPAL --- */
        .main-logo { max-width: 85%; width: 450px; margin-bottom: 1.5rem; filter: drop-shadow(0 8px 8px rgba(0,0,0,0.15)); }
        .menu-btn { 
            width: 240px; padding: 15px; margin: 6px; 
            background: var(--accent-color); color: white; 
            border: none; border-radius: 30px; font-size: 1.1rem; font-weight: bold; 
            text-transform: uppercase; cursor: pointer; box-shadow: var(--shadow);
        }
        .menu-btn:active { transform: translateY(2px); }
        .menu-btn.secondary { background: #555; font-size: 0.9rem; }
        .menu-btn.creative { background: #d35400; font-size: 0.95rem; margin-bottom:7px; }

        /* --- NIVELES --- */
        .levels-container { width: 90%; max-width: 600px; max-height: 70vh; overflow-y: auto; padding: 10px; }
        .levels-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; justify-items: center; }
        .level-card { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .level-card:active { transform: scale(0.95); }
        
        .level-box { 
            width: 70px; height: 70px; background: #ddd; border-radius: 10px; 
            overflow: hidden; border: 3px solid white; box-shadow: var(--shadow);
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .level-box canvas { width: 100%; height: 100%; image-rendering: pixelated; }
        .level-card.locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .stars { font-size: 14px; margin-top: 5px; color: #FFD700; text-shadow: 0 1px 1px rgba(0,0,0,0.2); height: 20px; letter-spacing: 1px; }

        /* --- JUEGO (LAYOUT PRO) --- */
        #game-layout {
            display: flex; flex-direction: column; align-items: center; 
            width: 100%; height: 100%; padding-top: 10px;
            max-width: 600px; 
        }

        /* CABECERA */
        .header-bar { 
            display: grid; grid-template-columns: 70px 1fr 70px; 
            width: 95%; margin-bottom: 10px; align-items: center; 
        }
        .back-btn-game { 
            background: #555; color: white; border: none; padding: 6px 10px; 
            border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.7rem; 
            box-shadow: var(--shadow); justify-self: start;
        }
        .title-group { text-align: center; }
        #level-num { font-size: 0.75rem; color: #777; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        #level-title { margin: -4; font-size: 1.3rem; color: var(--accent-color); font-weight: 900; line-height: 3; text-shadow: 0 1px 0 rgba(255,255,255,0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ZONA CENTRAL */
        .main-stage {
            display: flex; flex-direction: row; justify-content: center; align-items: flex-start;
            gap: 20px; width: 98%; margin-bottom: 5px;
        }
        .left-panel { display: flex; flex-direction: column; align-items: center; width: 160px; }
        
        .target-wrapper {
            background: white; padding: 5px; border-radius: 10px; 
            box-shadow: var(--shadow); margin-bottom: 15px;
            display: flex; flex-direction: column; align-items: center;
        }
        /* Escritorio: 130px */
        #targetCanvas { width: 100px; height: 100px; background: #99d0df; border-radius: 6px; image-rendering: pixelated; }
        .label-target { font-size: 0.65rem; color: #888; font-weight: bold; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }

        #info-box {
            background-color: #0d2b2b; color: #ecf0f1; padding: 10px; width: 100%; border-radius: 8px; 
            text-align: center; font-size: 0.8rem; line-height: 1.3; box-shadow: var(--shadow); box-sizing: border-box;
            opacity: 0; transition: opacity 0.3s;
        }
        #info-box.visible { opacity: 1; }

        .right-panel { display: flex; flex-direction: column; align-items: center; }
        #simCanvas { width: 340px; height: 340px; background: #BFEFFF; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); image-rendering: pixelated; }
        #msg { height: 20px; font-weight: 900; margin-top: 5px; color: var(--accent-color); text-align: center; font-size: 1rem; text-shadow: 0 1px 0 white; }

        /* CONTROLES (Escritorio) */
        .controls-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 95%; max-width: 500px; }
        .tool-btn { 
            aspect-ratio: 1; border-radius: 10px; border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.6rem; font-weight: bold; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.9);
            position: relative; overflow: hidden; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s; background-color: #888;
        }
        .tool-btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-tex { position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0.9; z-index: 0; background-size: cover; background-position: center; }
        .btn-label { position: relative; z-index: 2; margin-top: auto; padding-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.6rem; }
        .btn-icon-locked { font-size: 1.5rem; opacity: 0.4; z-index: 2; position: relative; }
        .btn-grey { background-color: #666; } 
        .btn-sys { grid-column: span 2; height: 40px; aspect-ratio: auto; background-color: #444; font-size: 0.8rem; letter-spacing: 1px; }
        .btn-check { grid-column: span 4; height: 45px; aspect-ratio: auto; background-color: var(--accent-color); font-size: 1rem; margin-top: 2px; }

        /* AYUDA */
        .help-wrapper { background: white; padding: 0; border-radius: 15px; max-width: 550px; width: 95%; height: 80vh; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; }
        .help-header { background: var(--accent-color); color: white; padding: 20px; text-align: center; flex-shrink: 0; }
        .help-header h2 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; }
        .help-body { padding: 25px; overflow-y: auto; flex-grow: 1; }
        .help-section { margin-bottom: 25px; }
        .help-title { color: var(--accent-color); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px; font-size: 1.1rem; }
        .help-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .help-item-box { background: #f8f9fa; padding: 10px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid #eee; }
        .help-icon { font-size: 2rem; margin-bottom: 5px; }
        .help-text strong { display: block; color: #333; font-size: 0.9rem; margin-bottom: 3px; }
        .help-text p { margin: 0; color: #666; font-size: 0.8rem; line-height: 1.3; }
        .help-rule { background: #eef5f5; border-left: 4px solid var(--accent-color); padding: 10px 15px; margin-bottom: 10px; font-size: 0.9rem; color: #444; }
        .help-footer { padding: 15px; background: #eee; text-align: center; flex-shrink: 0; }

        /* --- OPTIMIZACI√ìN M√ìVIL --- */
        @media (max-width: 600px) {
            .header-bar { margin-bottom: 2px; }
            #level-title { font-size: 1rem; }
            .main-stage { flex-direction: column; align-items: center; gap: 2px; margin-bottom: 2px; }
            .left-panel { flex-direction: row; width: auto; justify-content: space-around; align-items: center; gap: 5px; margin-bottom: 12px; }
            
            /* Objetivo MUY peque√±o (100px) */
            .target-wrapper { margin-bottom: 0; padding: 2px; }
            #targetCanvas { width: 100px; height: 100px; }
            .label-target { font-size: 0.55rem; margin-top: 1px; }
            
            /* Info box compacta */
            #info-box { width: 160px; font-size: 0.6rem; padding: 4px; line-height: 1,1; }
            
            /* Lienzo principal y mensaje */
            #simCanvas { width: 280px; height: 280px; }
            #msg { height: 15px; font-size: 0.8rem; margin-top: 2px; }

            /* Controles: M√°s peque√±os y con espacio */
            .controls-grid { 
                gap: 6px; /* M√ÅS ESPACIO */
                width: 90%; 
                max-width: 280px; /* Ancho m√°ximo reducido para forzar botones peque√±os */
            }
            .tool-btn { 
                border-radius: 6px; 
                box-shadow: 0 2px 0 rgba(0,0,0,0.2); 
            }
            .tool-btn:active { transform: translateY(2px); }
            .btn-label { font-size: 0.5rem; padding-bo‚Ä¶</style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <img src="img/geologic.png" alt="GEO-LOGIC" class="main-logo">
        <button class="menu-btn" onclick="continueGame()">JUGAR</button>
        <button class="menu-btn secondary" onclick="showLevels()">NIVELES</button>
        <button class="menu-btn creative" onclick="enterPlayground()">PLAYGROUND</button>
        <button class="menu-btn secondary" onclick="showHelp()">AYUDA</button>
        <div style="margin-top:10px; color:#aaa; font-size:0.7rem;" id="loading-text">por Ernesto Santana</div>
    </div>

    <div id="screen-levels" class="screen">
        <div style="width:90%; max-width:600px; display:flex; align-items:left; margin-bottom:20px;">
            <button class="back-btn-game" onclick="showMenu()">¬´</button>
            <h2 style="flex-grow:1; text-align:center; margin:0; color:#1a3c3c;">NIVELES</h2>
            <div style="width:60px;"></div>
        </div>
        <div class="levels-container">
            <div id="levels-grid" class="levels-grid"></div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-layout">
            <div class="header-bar">
                <button class="back-btn-game" onclick="showMenu()">¬´ MEN√ö</button>
                <div class="title-group"><div id="level-num"></div><h3 id="level-title">MODO CREATIVO</h3></div>
                <div></div>
            </div>

            <div class="main-stage">
                <div class="left-panel">
                    <div class="target-wrapper">
                        <canvas id="targetCanvas" width="130" height="130"></canvas>
                        <div class="label-target">OBJETIVO</div>
                    </div>
                    <div id="info-box" class="visible">MODO LIBRE<br>Crea y experimenta sin l√≠mites.</div>
                </div>
                <div class="right-panel">
                    <canvas id="simCanvas" width="340" height="340"></canvas>
                    <div id="msg"></div>
                </div>
            </div>

            <div class="controls-grid">
                <button class="tool-btn" onclick="action(1)"><div class="btn-tex" style="background-image:url('img/arenisca.jpg'); background-color:#F4A460"></div><span class="btn-label">ARENISCA</span></button>
                <button class="tool-btn" onclick="action(2)"><div class="btn-tex" style="background-image:url('img/Pizarra.jpg'); background-color:#708090"></div><span class="btn-label">PIZARRA</span></button>
                <button class="tool-btn" onclick="action(3)"><div class="btn-tex" style="background-image:url('img/caliza.jpg'); background-color:#F0E68C"></div><span class="btn-label">CALIZA</span></button>
                <button class="tool-btn" onclick="action(4)"><div class="btn-tex" style="background-image:url('img/Conglomerado.jpg'); background-color:#8B4513"></div><span class="btn-label">CONGLOM.</span></button>

                <button class="tool-btn btn-grey" id="btn-erosion" onclick="action(5)" data-label="EROSI√ìN" data-img="EROSION.jpg" style="pointer-events: all;"><div class="btn-tex" style="background-image:url('img/EROSION.jpg');"></div><span class="btn-label">EROSI√ìN</span></button>
                <button class="tool-btn btn-grey" id="btn-fold" onclick="action(6)" data-label="PLIEGUE" data-img="PLIEGUE.jpg" style="pointer-events: all;"><div class="btn-tex" style="background-image:url('img/PLIEGUE.jpg');"></div><span class="btn-label">PLIEGUE</span></button>
                <button class="tool-btn btn-grey" id="btn-fault" onclick="action(7)" data-label="FALLA" data-img="FALLA.jpg" style="pointer-events: all;"><div class="btn-tex" style="background-image:url('img/FALLA.jpg');"></div><span class="btn-label">FALLA</span></button>
                <button class="tool-btn btn-grey" id="btn-intrusion" onclick="action(8)" data-label="INTRUSION" data-img="INTRUSION.jpg" style="pointer-events: all;"><div class="btn-tex" style="background-image:url('img/INTRUSION.jpg');"></div><span class="btn-label">INTRUSION</span></button>

                <button class="tool-btn btn-sys" onclick="undo()">DESHACER</button>
                <button class="tool-btn btn-sys" onclick="resetLevel()">LIMPIAR</button>
                <button class="tool-btn btn-check" id="btn-check" onclick="check()" style="display: none;">COMPROBAR</button>
            </div>
        </div>
    </div>

    <div id="screen-help" class="screen">
        <div class="help-wrapper">
            <div class="help-header"><h2>Manual de Campo</h2></div>
            <div class="help-body">
                <div class="help-section">
                    <h3 class="help-title">üéØ El Objetivo</h3>
                    <p style="color:#555">Tu misi√≥n es observar el corte geol√≥gico del recuadro peque√±o y <strong>replicar su historia</strong> paso a paso en el lienzo grande.</p>
                </div>
                
                <div class="help-section">
                    <h3 class="help-title">‚≠ê Puntuaci√≥n</h3>
                    <div style="background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #eee;">
                        <div style="display:flex; align-items:center; margin-bottom:5px;">
                            <span style="color:#FFD700; margin-right:10px; font-size:1.2rem;">‚òÖ‚òÖ‚òÖ</span>
                            <span style="font-size:0.9rem; color:#444;"><strong>Perfecto:</strong> Sin errores.</span>
                        </div>
                        <div style="display:flex; align-items:center; margin-bottom:5px;">
                            <span style="color:#FFD700; margin-right:10px; font-size:1.2rem;">‚òÖ‚òÖ</span>
                            <span style="font-size:0.9rem; color:#444;"><strong>Casi:</strong> 1 correcci√≥n (Deshacer).</span>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span style="color:#FFD700; margin-right:10px; font-size:1.2rem;">‚òÖ</span>
                            <span style="font-size:0.9rem; color:#444;"><strong>Bien:</strong> Varios errores.</span>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3 class="help-title">üìú Reglas de Oro</h3>
                    <div class="help-rule"><strong>1. Superposici√≥n:</strong> Las capas nuevas siempre se depositan encima de las antiguas.</div>
                    <div class="help-rule"><strong>2. Corte y Cruce:</strong> Si una falla o intrusi√≥n corta una capa, ocurri√≥ <em>despu√©s</em> de esa capa.</div>
                </div>
                <div class="help-section">
                    <h3 class="help-title">üõ†Ô∏è Herramientas</h3>
                    <div class="help-grid">
                        <div class="help-item-box"><div class="help-icon">üß±</div><div class="help-text"><strong>Sedimentaci√≥n</strong>Deposita rocas en capas horizontales.</div></div>
                        <div class="help-item-box"><div class="help-icon">üåßÔ∏è</div><div class="help-text"><strong>Erosi√≥n</strong>Desgasta la superficie hasta dejarla plana.</div></div>
                        <div class="help-item-box"><div class="help-icon">„Ä∞Ô∏è</div><div class="help-text"><strong>Tect√≥nica</strong>Pliegues y Fallas que deforman la roca.</div></div>
                        <div class="help-item-box"><div class="help-icon">üåã</div><div class="help-text"><strong>Magmatismo</strong>Intrusiones de roca fundida.</div></div>
                    </div>
                </div>
            </div>
            <div class="help-footer">
                <button class="menu-btn secondary" style="width:100%; margin:0;" onclick="showMenu()">ENTENDIDO</button>
            </div>
        </div>
    </div>

<script>
    try { if(!sessionStorage.getItem('v84_clean')) { localStorage.removeItem('maxLvl'); sessionStorage.setItem('v84_clean','true'); } } catch(e){}

    const W = 340, H = 340; 
    const TW = 130, TH = 130; 
    const ctxP = document.getElementById('simCanvas').getContext('2d');
    const ctxT = document.getElementById('targetCanvas').getContext('2d');
    
    const textureFiles = { 
        0:'img/Cielo.jpg', 
        1:'img/arenisca.jpg', 
        2:'img/Pizarra.jpg', 
        3:'img/caliza.jpg',        
        4:'img/Conglomerado.jpg',  
        8:'img/magma.jpg', 
        9:'img/basament.jpg' 
    };
    let textures = {}, loadedCount = 0;
    for(let id in textureFiles){
        let i = new Image(); i.src=textureFiles[id]; i.crossOrigin="Anonymous";
        i.onload = ()=>{ 
            let c=document.createElement('canvas'); c.width=i.width; c.height=i.height; 
            c.getContext('2d').drawImage(i,0,0);
            try { textures[id]={data:c.getContext('2d').getImageData(0,0,i.width,i.height).data, w:i.width, h:i.height}; loadedCount++; 
            if(loadedCount>=5) document.getElementById('loading-text').innerText=""; } catch(e){}
        };
    }

    const SCHEMATIC_COLORS = { 0:[153,208,223], 1:[221,189,137], 2:[70,76,82], 3:[226,226,226], 4:[100,73,43], 8:[220,85,40], 9:[19,36,37] };
    const COLORS = { 0:[191,239,255], 9:[47,79,79], 1:[244,164,96], 2:[112,128,144], 3:[240,230,140], 4:[139,69,19], 8:[220,85,40] };

    const LEVELS = [
        { id:1, name:"Principios B√°sicos", seq:[1,2,3] },
        { id:2, name:"Torre Sedimentaria", seq:[3,2,1,4,3,2] },
        { id:3, name:"Cimientos", seq:[2,1,1,3,4] },
        { id:4, name:"Emparedado", seq:[1,4,4,1] },
        { id:5, name:"Primera Erosi√≥n", seq:[3,1,2,5] },
        { id:6, name:"Discordancia", seq:[4,5,1,3] },
        { id:7, name:"Valles y Cumbres", seq:[5,3,2,1,5,4] },
        { id:8, name:"Desgaste Total", seq:[5,3,5,2,5,1,5,4,5] },
        { id:9, name:"El Gran Ca√±√≥n", seq:[3,2,5,5,5,1] },
        { id:10, name:"Paleorrelieve", seq:[4,3,5,5,2,5,1,1] },
        { id:11, name:"Fuerzas Compresivas", seq:[1,2,3,6] },
        { id:12, name:"Base Ondulada", seq:[6,1,2,3] },
        { id:13, name:"Sinclinal Oculto", seq:[1,3,6,4,2] },
        { id:14, name:"Orog√©nesis", seq:[3,4,6,1,2,6] },
        { id:15, name:"Anticlinal Erosionado", seq:[3,4,5,5,6] },
        { id:16, name:"Tect√≥nica Activa", seq:[1,3,5,5,6,4] },
        { id:17, name:"Discordancia Angular", seq:[2,1,6,5,4] },
        { id:18, name:"Caos Tect√≥nico", seq:[3,2,6,5,5,1,6,4] },
        { id:19, name:"Ruptura", seq:[1,2,3,7] },
        { id:20, name:"Falla Activa", seq:[1,2,3,7,4] },
        { id:21, name:"Trampa Petrol√≠fera", seq:[1,3,4,6,7] },
        { id:22, name:"Bloque Elevado", seq:[1,4,2,5,7] },
        { id:23, name:"Graben", seq:[4,3,2,7,5] },
        { id:24, name:"Historia Rota", seq:[1,5,5,2,3,7] },
        { id:25, name:"Sistema de Fallas", seq:[4,2,3,7,1,7] },
        { id:26, name:"El Dique", seq:[1,2,3,8] }, 
        { id:27, name:"Volc√°n Dormido", seq:[4,3,2,8,5] }, 
        { id:28, name:"Inyecci√≥n Reciente", seq:[1,2,5,3,8] }, 
        { id:29, name:"Pliegue Cortado", seq:[1,2,6,8] }, 
        { id:30, name:"Dique Plegado", seq:[1,2,8,6] }, 
        { id:31, name:"Dique Fallado", seq:[3,4,8,7] }, 
        { id:32, name:"Cicatriz √çgnea", seq:[3,4,7,8] }, 
        { id:33, name:"Discordancia Magm√°tica", seq:[1,2,8,5,4] }, 
        { id:34, name:"Intrusi√≥n Profunda", seq:[2,3,6,5,8,1] }, 
        { id:35, name:"Tect√≥nica √çgnea", seq:[1,2,8,6,7] }, 
        { id:36, name:"Doble Evento", seq:[4,8,5,1,8] }, 
        { id:37, name:"La Chimenea", seq:[2,6,5,3,7,8] }, 
        { id:38, name:"Bloque Magm√°tico", seq:[1,2,8,5,7,5,5] }, 
        { id:39, name:"Historia Completa", seq:[3,2,6,5,4,8,7] }, 
        { id:40, name:"El Gran Ciclo", seq:[1,2,3,6,5,7,8,5,4] },
        { id:41, name:"Tect√≥nica Cruzada", seq:[2,3,6,5,1,8,7] }, 
        { id:42, name:"Caos Primordial", seq:[4,3,8,6,5,2,1,7] }
    ];

    let grid=[], targetGrid=[], history=[], userSeq=[], skyOff=0, undoCount=0;
    let currentLvl=0, maxLvl = parseInt(localStorage.getItem('maxLvl'))||0;
    let starsData = JSON.parse(localStorage.getItem('starsData'))||{};
    let isPlayground = false;

    function initGrid(w,h) { let g=[]; let bh=Math.floor(h*0.1); for(let y=0;y<h;y++){let r=[];for(let x=0;x<w;x++)r.push(y>h-bh?9:0);g.push(r);} return g; }
    
    function drawSchematic(g, ctx, targetW, targetH) {
        const img = ctx.createImageData(targetW, targetH); const px=img.data;
        const sH=g.length; const sW=g[0].length;
        for(let y=0;y<targetH;y++){
            for(let x=0;x<targetW;x++){
                const sy=Math.floor(y*(sH/targetH)); const sx=Math.floor(x*(sW/targetW));
                if(sy<sH && sx<sW){
                    const id=g[sy][sx]; let rgb=SCHEMATIC_COLORS[id]||[0,0,0];
                    const i=(y*targetW+x)*4; px[i]=rgb[0]; px[i+1]=rgb[1]; px[i+2]=rgb[2]; px[i+3]=255;
                }
            }
        }
        ctx.putImageData(img,0,0);
    }

    function drawTextured(g, ctx, w, h) {
        const d = ctx.createImageData(w,h); const px=d.data;
        for(let i=0; i<w*h; i++) {
            let x=i%w, y=Math.floor(i/w); let id=g[y][x]; let rgb=COLORS[id]||[0,0,0];
            if(id===0) {
                if(textures[0]) { let t=textures[0], tx=Math.floor((x+skyOff)%t.w), ty=y%t.h, ti=(ty*t.w+tx)*4; rgb=[t.data[ti],t.data[ti+1],t.data[ti+2]]; } 
                else rgb=SCHEMATIC_COLORS[0];
            } else if(textures[id]) {
                let t=textures[id], ti=((y%t.h)*t.w+(x%t.w))*4; rgb=[t.data[ti],t.data[ti+1],t.data[ti+2]];
            } else rgb = COLORS[id] || [0,0,0];
            
            if(id!==0) { let e=false; if(x<w-1 && g[y][x+1]!==id)e=true; if(y<h-1 && g[y+1][x]!==id)e=true; if(e) rgb=[30,30,30]; }
            px[i*4]=rgb[0]; px[i*4+1]=rgb[1]; px[i*4+2]=rgb[2]; px[i*4+3]=255;
        }
        ctx.putImageData(d,0,0);
    }

    function action(id, g=grid, w=W, h=H) {
        if(id===8 && !isPlayground) return; 
        if(g===grid) {
            if(!isPlayground) {
                let lvl = currentLvl + 1;
                if(id===5 && lvl < 5) return;  
                if(id===6 && lvl < 11) return; 
                if(id===7 && lvl < 19) return; 
                if(id===8 && lvl < 26) return; 
            }
            if(history.length>20) history.shift(); history.push({g:JSON.parse(JSON.stringify(grid)), s:[...userSeq]}); userSeq.push(id);
        }

        if(id<=4) { 
            let top=h; for(let x=0;x<w;x++)for(let y=0;y<h;y++)if(g[y][x]!==0){if(y<top)top=y;break;}
            let start=Math.max(0,top-Math.floor(h*0.15)); for(let y=start;y<h;y++)for(let x=0;x<w;x++)if(g[y][x]===0)g[y][x]=id;
        } else if(id===8) { 
            let thickness = 20;
            for(let x=0; x<w; x++) {
                for(let y=0; y<h; y++) {
                    let cx = (w/2) - (h/2 - y) * 0.6; 
                    if (Math.abs(x - cx) < thickness) {
                        if (g[y][x] !== 0) g[y][x] = 8;
                    }
                }
            }
        } else if(id===7) { 
            let t=JSON.parse(JSON.stringify(g));
            let slipY = Math.floor(h * 0.10); let slipX = Math.round(slipY / -1.5);
            for(let y=0; y<h; y++) {
                for(let x=0; x<w; x++) {
                    if (x > (y - h/2) / -1.5 + w/2) {
                        let targetSY = y - slipY; let targetSX = x - slipX;
                        let effectiveSX = Math.max(0, Math.min(w - 1, targetSX));
                        let sourceVal;
                        if (targetSY >= h) sourceVal = t[h - 1][effectiveSX];
                        else if (targetSY < 0) sourceVal = t[0][effectiveSX];
                        else sourceVal = t[targetSY][effectiveSX];
                        g[y][x] = sourceVal;
                    }
                }
            }
        } else if(id===6) { 
            let t=JSON.parse(JSON.stringify(g)), amp=Math.floor(h*0.08);
            for(let x=0;x<w;x++) { 
                let sh=Math.floor(Math.sin(x*0.025*(300/w))*amp); 
                for(let y=0;y<h;y++) { let sy=y+sh; if (sy >= h) g[y][x] = t[h-1][x]; else g[y][x] = (sy>=0&&sy<h) ? t[sy][x] : 0; } 
            }
        } else if(id===5) { 
            let p=h; for(let x=0;x<w;x++)for(let y=0;y<h;y++)if(g[y][x]!==0){if(y<p)p=y;break;}
            let b=p+Math.floor(h*0.05); for(let x=0;x<w;x++){ let c=Math.floor(b+Math.sin(x*0.05)*3+Math.cos(x*0.13)*1.5); for(let y=0;y<c&&y<h;y++)g[y][x]=0; }
        }
        if(isPlayground && g===grid) drawSchematic(grid, ctxT, TW, TH);
    }

    function updateUI(lvlIndex) {
        if(isPlayground) {
            document.getElementById('info-box').innerHTML = "MODO LIBRE<br>Crea y experimenta sin l√≠mites.";
            document.getElementById('info-box').classList.add('visible');
            configureButton('btn-erosion', true); configureButton('btn-fold', true); configureButton('btn-fault', true); configureButton('btn-intrusion', true);
            document.getElementById('btn-check').style.display = 'none';
            return;
        }
        document.getElementById('btn-check').style.display = 'grid';
        const lvl = lvlIndex + 1;
        const box = document.getElementById('info-box');
        let msg = "";
        if(lvl === 1) msg = "Bienvenido.<br>Deposita capas de roca sedimentaria.";
        else if(lvl === 5) msg = "¬°NUEVA HERRAMIENTA!<br><strong>Erosi√≥n:</strong> Desgasta la superficie.";
        else if(lvl === 11) msg = "¬°NUEVA HERRAMIENTA!<br><strong>Pliegue:</strong> Dobla las capas por presi√≥n.";
        else if(lvl === 19) msg = "¬°NUEVA HERRAMIENTA!<br><strong>Falla:</strong> Rompe y desplaza la tierra.";
        else if(lvl === 26) msg = "¬°NUEVA HERRAMIENTA!<br><strong>Intrusi√≥n:</strong> Magma que corta la roca.";
        if(msg) { box.innerHTML = msg; box.classList.add('visible'); } else { box.classList.remove('visible'); }
        configureButton('btn-erosion', lvl >= 5); configureButton('btn-fold', lvl >= 11); configureButton('btn-fault', lvl >= 19); configureButton('btn-intrusion', lvl >= 26);
    }

    function configureButton(id, unlocked) {
        const btn = document.getElementById(id);
        const label = btn.dataset.label; const imgFile = btn.dataset.img; 
        if(unlocked) {
            btn.style.pointerEvents = "all";
            btn.innerHTML = `<div class="btn-tex" style="background-image:url('img/${imgFile}');"></div><span class="btn-label">${label}</span>`;
        } else {
            btn.innerHTML = `<span class="btn-icon-locked">?</span>`;
            btn.style.pointerEvents = "none";
        }
    }

    function enterPlayground() {
        isPlayground = true; currentLvl = -1; history=[]; userSeq=[]; undoCount=0;
        document.getElementById('msg').innerText="";
        document.getElementById('level-num').innerText="";
        document.getElementById('level-title').innerText="MODO CREATIVO";
        resetLevel(); updateUI(0); drawSchematic(grid, ctxT, TW, TH); showScreen('game');
    }

    function loadLevel(i) {
        isPlayground = false; currentLvl=i; history=[]; userSeq=[]; undoCount=0;
        document.getElementById('msg').innerText="";
        document.getElementById('level-num').innerText="NIVEL "+LEVELS[i].id;
        document.getElementById('level-title').innerText=LEVELS[i].name;
        updateUI(i); 
        targetGrid=initGrid(TW,TH); LEVELS[i].seq.forEach(a=>action(a,targetGrid,TW,TH)); 
        drawSchematic(targetGrid,ctxT,TW,TH);
        resetLevel();
    }

    function resetLevel() { grid=initGrid(W,H); history=[]; userSeq=[]; undoCount=0; if(isPlayground) drawSchematic(grid, ctxT, TW, TH);}
    
    function undo() { 
        if(history.length>0){ 
            let s=history.pop(); grid=s.g; userSeq=s.s; 
            if(!isPlayground) undoCount++;
            if(isPlayground) drawSchematic(grid, ctxT, TW, TH); 
        } 
    }

    function check() {
        if(isPlayground) return; 
        if(JSON.stringify(LEVELS[currentLvl].seq)===JSON.stringify(userSeq)){
            let s=1; if(undoCount===0) s=3; else if(undoCount===1) s=2;
            if(!starsData[currentLvl] || s>starsData[currentLvl]) { starsData[currentLvl]=s; localStorage.setItem('starsData',JSON.stringify(starsData)); }
            document.getElementById('msg').innerHTML="¬°CORRECTO! "+'‚òÖ'.repeat(s);
            if(currentLvl===maxLvl && maxLvl<LEVELS.length-1) { maxLvl++; localStorage.setItem('maxLvl',maxLvl); }
            setTimeout(()=>{ if(currentLvl<LEVELS.length-1)loadLevel(currentLvl+1); else showMenu(); },1500);
        } else document.getElementById('msg').innerHTML="INCORRECTO";
    }

    function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById('screen-'+id).classList.add('active'); }
    function showMenu(){ showScreen('menu'); } function showLevels(){ renderLevels(); showScreen('levels'); } function showHelp(){ showScreen('help'); } function continueGame(){ loadLevel(maxLvl); showScreen('game'); }

    function renderLevels() {
        let c=document.getElementById('levels-grid'); c.innerHTML='';
        LEVELS.forEach((l,i)=>{
            let d=document.createElement('div'); d.className='level-card';
            let b=document.createElement('div'); b.className='level-box';
            if(i <= maxLvl) {
                if(starsData[i]!==undefined) {
                    let cv=document.createElement('canvas'); cv.width=70; cv.height=70; b.appendChild(cv);
                    let g=initGrid(70,70); l.seq.forEach(a=>action(a,g,70,70)); drawSchematic(g,cv.getContext('2d'),70,70);
                } else b.innerHTML='<span style="font-size:30px; color:#888;">?</span>';
                d.onclick=()=>{loadLevel(i); showScreen('game');};
            } else { d.classList.add('locked'); b.innerHTML='<span style="font-size:20px; opacity:0.5;">üîí</span>'; }
            d.appendChild(b);
            let sDiv = document.createElement('div'); sDiv.className='stars';
            if(starsData[i]) sDiv.innerText = '‚òÖ'.repeat(starsData[i]);
            d.appendChild(sDiv);
            c.appendChild(d);
        });
    }

    function loop() { skyOff+=0.25; if(document.getElementById('screen-game').classList.contains('active')) drawTextured(grid,ctxP,W,H); requestAnimationFrame(loop); }
    loop();
</script>

</body></html>


